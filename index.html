<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Planas de Hidalgo</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    /* ------------------------------------------------ */
    /* ESTILOS BASE                     */
    /* ------------------------------------------------ */
    :root {
      --color-fondo-pagina: #2c3e50; /* Azul Marino Oscuro */
      --color-fondo-form: #34495e; /* Azul Gris치ceo */
      --color-primary: #e74c3c; /* Rojo Ladrillo (Acci칩n Principal) */
      --color-primary-hover: #c0392b; 
      --color-secondary: #3498db; /* Azul Claro (Limpiar/Editar) */
      --color-secondary-hover: #2980b9; 
      --color-danger: #9b59b6; /* P칰rpura (Borrar Todo) */
      --color-danger-hover: #8e44ad; 
      --color-light-text: #ecf0f1; /* Texto Principal */
      --color-dark-text: #2c3e50;
      --color-input-bg: #ecf0f1; /* Fondo de inputs: Gris Claro */
      --color-alerta-vacio: #f1c40f; /* Amarillo Intenso */
      --radius: 5px;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
      line-height: 1.6;
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--color-light-text);
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
    }
    
    /* ------------------------------------------------ */
    /* FORMULARIO                       */
    /* ------------------------------------------------ */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto; /* Etiqueta | Campo | Checkbox */
      gap: 15px 20px;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    /* Campos de ancho completo: Titular */
    label[for="titular"], .campo-titular { grid-column: 1 / span 3; }
    
    /* Campo Titular se extiende en la columna 2/3 */
    .campo-titular .campo-input { grid-column: 2 / 3; } 
    
    label {
        font-weight: 700;
        align-self: center;
        text-align: right;
    }
    .campo-input {
      position: relative;
      display: flex;
      align-items: center;
      grid-column: 2 / 3;
    }
    input[type="text"], 
    input[type="date"] {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #7f8c8d;
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.2s;
    }
    input[type="text"]:focus,
    input[type="date"]:focus {
        border-color: var(--color-secondary);
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5);
        outline: none;
    }

    /* Estilo para campo bloqueado (readOnly) */
    .bloqueado { 
        background-color: #bdc3c7 !important; /* Gris m치s claro */
        cursor: not-allowed; 
        color: #7f8c8d !important;
        border: 1px dashed #7f8c8d !important;
    }

    /* Checkbox de bloqueo (columna 3) */
    .campo-lock {
        display: flex;
        align-items: center;
        justify-content: center;
        padding-right: 10px;
        grid-column: 3 / 4;
    }
    .campo-lock label {
        cursor: pointer;
        margin-left: 5px;
        font-size: 1.2em;
        color: var(--color-light-text);
    }
    .campo-lock input[type="checkbox"] {
        display: none;
    }
    .campo-lock input[type="checkbox"]:checked + label i {
        color: var(--color-primary); /* Candado se pone rojo al bloquear */
    }

    /* Indicador de campo obligatorio */
    input:required:invalid { border-left: 5px solid var(--color-primary); }
    input:required:valid { border-left: 5px solid #2ecc71; /* Verde */ }

    /* ------------------------------------------------ */
    /* SUGERENCIAS                      */
    /* ------------------------------------------------ */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-secondary);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
      margin-top: 2px;
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #ecf0f1; }
    .btn-dropdown {
        padding: 8px;
        border: none;
        background-color: var(--color-secondary);
        color: var(--color-light-text);
        margin-left: 5px;
        border-radius: var(--radius);
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-dropdown:hover { background-color: var(--color-secondary-hover); }

    /* ------------------------------------------------ */
    /* BOTONES ACCI칍N                   */
    /* ------------------------------------------------ */
    .button-group-form {
        grid-column: 1 / span 3;
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
    }
    .button-group-table {
        margin-top: 30px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        justify-content: flex-start;
        flex-wrap: wrap;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnBorrarTodo { background-color: var(--color-danger); }
    #btnBorrarTodo:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    #btnExportar { background-color: #16a085; } /* Verde Esmeralda */
    #btnExportar:hover { background-color: #1abc9c; } 
    #btnEliminarNota { background-color: #c0392b; display: none; }
    #btnEliminarNota:hover { background-color: #e74c3c; }

    button i { margin-right: 8px; font-size: 1.1em; }

    /* ------------------------------------------------ */
    /* TABLA DE REGISTROS               */
    /* ------------------------------------------------ */
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      background-color: var(--color-fondo-form);
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      table-layout: fixed;
    }
    th, td {
      padding: 12px 8px;
      border: 1px solid #7f8c8d;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      word-wrap: break-word; 
      overflow: hidden;
      white-space: nowrap; 
      text-overflow: ellipsis;
    }
    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
    }
    tbody tr:nth-child(even) { background-color: #4e6074; } 
    tbody tr:hover { background-color: #5d7188; cursor: pointer; }
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .editando td { color: var(--color-light-text); }
    
    /* Resaltado amarillo para campo Tema vac칤o */
    .alerta-vacio td:nth-child(9) { /* Columna 9 es Tema en el orden final */
        background-color: var(--color-alerta-vacio) !important;
        color: var(--color-dark-text) !important;
    }
    
    /* Anchos de columnas (11 columnas: #, 10 datos) */
    #tablaNotas th:nth-child(1), #tablaNotas td:nth-child(1) { width: 4%; }    /* # */
    #tablaNotas th:nth-child(2), #tablaNotas td:nth-child(2) { width: 8%; }    /* Usuario */
    #tablaNotas th:nth-child(3), #tablaNotas td:nth-child(3) { width: 7%; }    /* Fecha */
    #tablaNotas th:nth-child(4), #tablaNotas td:nth-child(4) { width: 10%; }   /* Medio */
    #tablaNotas th:nth-child(5), #tablaNotas td:nth-child(5) { width: 25%; }   /* Titular */
    #tablaNotas th:nth-child(6), #tablaNotas td:nth-child(6) { width: 8%; }    /* Recurso */
    #tablaNotas th:nth-child(7), #tablaNotas td:nth-child(7) { width: 10%; }   /* Dependencia */
    #tablaNotas th:nth-child(8), #tablaNotas td:nth-child(8) { width: 10%; }   /* Organismo */
    #tablaNotas th:nth-child(9), #tablaNotas td:nth-child(9) { width: 8%; }    /* Tema */
    #tablaNotas th:nth-child(10), #tablaNotas td:nth-child(10) { width: 5%; }  /* Estatus */
    #tablaNotas th:nth-child(11), #tablaNotas td:nth-child(11) { width: 5%; }  /* Acciones */


    .btn-accion-tabla {
        padding: 6px 10px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
        font-size: 0.75rem;
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }

    .error-carga {
      color: var(--color-primary);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 15px;
      border-radius: var(--radius);
      color: var(--color-dark-text);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      line-height: 1.4;
      text-align: center;
      border: 2px solid var(--color-primary);
    }
    
    /* RESPONSIVE */
    @media (max-width: 600px) {
        form {
            grid-template-columns: 1fr;
            padding: 15px;
        }
        label, .campo-input, .campo-lock {
            grid-column: 1 / span 1 !important;
            text-align: left;
        }
        label { margin-bottom: 0; }
        .campo-input { order: 2; margin-top: -10px; }
        .campo-lock { order: 3; justify-content: flex-end; margin-top: -10px; }
        
        label:nth-child(3n-2) { order: 1; }
        .campo-input:nth-child(3n-1) { order: 2; }
        .campo-lock:nth-child(3n) { order: 3; }

        .button-group-form { flex-direction: column; gap: 10px; }
        .button-group-form button { width: 100%; }
        
        .button-group-table { flex-direction: column; gap: 10px; }
        .button-group-table button { width: 100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Captura de Planas de Peri칩dicos</h1>

  <div id="errorCargaCSV" class="error-carga" style="display: none;">
      丘멆잺 **Error al cargar archivos CSV (Medio, Recurso, etc.).** 丘멆잺
      <br>
      Esto sucede si abre el archivo HTML directamente desde su computadora (`file:///...`) debido a restricciones de seguridad del navegador (CORS).
      <br><br>
      **SOLUCI칍N RECOMENDADA:** Suba este archivo HTML a **GitHub Pages** (como su formulario anterior) o use un servidor web local (como Live Server de VS Code).
  </div>

  <form id="formCaptura" onsubmit="event.preventDefault()">
    <label for="usuario">Usuario:</label>
    <div class="campo-input">
      <input type="text" id="usuario" name="usuario" required data-next-input="fecha">
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkUsuario" onclick="alternarBloqueo('usuario')">
      <label for="checkUsuario" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo-input">
      <input type="date" id="fecha" name="fecha" required data-next-input="medio">
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkFecha" onclick="alternarBloqueo('fecha')">
      <label for="checkFecha" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo-input">
      <input type="text" id="medio" name="medio" autocomplete="off" required data-next-input="titular">
      <button type="button" class="btn-dropdown" onclick="mostrarSugerencias('medio')" tabindex="-1">游댷</button>
      <div id="sugMedio" class="sugerencias"></div>
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkMedio" onclick="alternarBloqueo('medio')">
      <label for="checkMedio" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>
    
    <label for="titular">Titular:</label>
    <div class="campo-input campo-titular">
      <input type="text" id="titular" name="titular" required data-next-input="recurso">
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkTitular" onclick="alternarBloqueo('titular')">
      <label for="checkTitular" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>
    
    <label for="recurso">Recurso editorial:</label>
    <div class="campo-input">
      <input type="text" id="recurso" name="recurso" autocomplete="off" required data-next-input="dependencia">
      <button type="button" class="btn-dropdown" onclick="mostrarSugerencias('recurso')" tabindex="-1">游댷</button>
      <div id="sugRecurso" class="sugerencias"></div>
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkRecurso" onclick="alternarBloqueo('recurso')">
      <label for="checkRecurso" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo-input">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required data-next-input="organismo">
      <button type="button" class="btn-dropdown" onclick="mostrarSugerencias('dependencia')" tabindex="-1">游댷</button>
      <div id="sugDep" class="sugerencias"></div>
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkDependencia" onclick="alternarBloqueo('dependencia')">
      <label for="checkDependencia" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>

    <label for="organismo">Organismo:</label>
    <div class="campo-input">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required data-next-input="tema">
      <button type="button" class="btn-dropdown" onclick="mostrarSugerencias('organismo')" tabindex="-1">游댷</button>
      <div id="sugOrg" class="sugerencias"></div>
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkOrganismo" onclick="alternarBloqueo('organismo')">
      <label for="checkOrganismo" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>
    
    <label for="tema">Tema:</label>
    <div class="campo-input">
      <input type="text" id="tema" name="tema" autocomplete="off" data-next-input="estatus">
      <button type="button" class="btn-dropdown" onclick="mostrarSugerencias('tema')" tabindex="-1">游댷</button>
      <div id="sugTema" class="sugerencias"></div>
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkTema" onclick="alternarBloqueo('tema')">
      <label for="checkTema" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>

    <label for="estatus">Estatus:</label>
    <div class="campo-input">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required data-next-input="usuario"> <button type="button" class="btn-dropdown" onclick="mostrarSugerencias('estatus')" tabindex="-1">游댷</button>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>
    <div class="campo-lock">
      <input type="checkbox" id="checkEstatus" onclick="alternarBloqueo('estatus')">
      <label for="checkEstatus" title="Bloquear (Ctrl+Shift+L)"><i class="fas fa-lock"></i></label>
    </div>
    
    <div class="button-group-form">
      <button type="button" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar (Ctrl+Q)
      </button>
      <button type="button" id="btnEliminarNota" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>
      <button type="button" id="btnLimpiar" onclick="limpiarFormulario()">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="button-group-table">
    <button id="btnExportar" onclick="exportarCSV()">
      <i class="fa-solid fa-download"></i> Exportar CSV
    </button>
    <button id="btnBorrarTodo" onclick="borrarTodo()">
      <i class="fa-solid fa-skull-crossbones"></i> BORRAR TODO
    </button>
  </div>
  
  <hr>

  <h2>Registros Capturados</h2>
  
  <table id="tablaNotas">
    <thead>
      <tr>
        <th>#</th>
        <th>Usuario</th>
        <th>Fecha</th>
        <th>Medio</th>
        <th>Titular</th>
        <th>Recurso editorial</th>
        <th>Dependencia</th>
        <th>Organismo</th>
        <th>Tema</th>
        <th>Estatus</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>
  
</div>

<script>
    // ======================================================================
    // 游릭 CONFIGURACI칍N DE URLS DE GITHUB (FORMATO RAW) 游릭
    // ======================================================================
    const urls = {
        medio: "https://raw.githubusercontent.com/thelonious9/captura-portadas/main/Medio.csv",
        recurso: "https://raw.githubusercontent.com/thelonious9/captura-portadas/main/Recursos.csv",
        dependencia: "https://raw.githubusercontent.com/thelonious9/captura-portadas/main/Dependencia.csv",
        tema: "https://raw.githubusercontent.com/thelonious9/captura-portadas/main/Tema.csv",
        estatus: "https://raw.githubusercontent.com/thelonious9/captura-portadas/main/Estatus.csv"
    };

    // ======================================================================
    // 游 CONSTANTES GLOBALES Y ESTRUCTURA DE DATOS 游
    // ======================================================================
    const camposDeDatos = [
        'ordenCaptura', 
        'usuario', 
        'fecha', 
        'medio', 
        'titular', 
        'recurso', 
        'dependencia', 
        'organismo', 
        'tema', 
        'estatus', 
    ];
    
    const encabezadosTabla = {
        'ordenCaptura': '#', 
        'usuario': 'Usuario', 
        'fecha': 'Fecha', 
        'medio': 'Medio', 
        'titular': 'Titular', 
        'recurso': 'Recurso editorial', 
        'dependencia': 'Dependencia', 
        'organismo': 'Organismo', 
        'tema': 'Tema', 
        'estatus': 'Estatus', 
    };
    
    const camposObligatorios = camposDeDatos.filter(c => c !== 'ordenCaptura' && c !== 'tema');

    let notas = [];
    let nextOrdenCaptura = 1;
    let filaEnEdicion = null;
    let dependenciaMap = {}; 
    let listasAutocompletado = {}; // Almacenar치 todas las listas: {medio: [...], recurso: [...]}

    // ======================================================================
    // ---------------------- Carga y Procesamiento CSV ---------------------
    // ======================================================================

    /**
     * Carga el contenido RAW de una URL CSV.
     */
    async function cargarCSV(url) {
        try {
            const response = await fetch(url + '?t=' + Date.now()); 
            if (!response.ok) {
                // Si falla por CORS o 404
                throw new Error(`Fallo en la carga del CSV (Status: ${response.status})`); 
            }
            return await response.text();
        } catch (error) {
            console.error(`Error al cargar ${url}:`, error);
            document.getElementById("errorCargaCSV").style.display = 'block';
            throw error;
        }
    }

    /**
     * Procesa un CSV con dos columnas (Clave, Valor) para crear un mapa.
     */
    async function cargarMapa(url) {
        const text = await cargarCSV(url);
        const filas = text.trim().split('\n').slice(1).filter(l => l.trim());
        const map = {};
        const claves = new Set();
        
        filas.forEach(line => {
            const [clave, valor] = line.split(',').map(item => item.trim().replace(/^"|"$/g, ''));
            if (clave && valor) {
                if (!map[clave]) map[clave] = new Set();
                map[clave].add(valor);
                claves.add(clave);
            }
        });

        const mapArrays = {};
        Array.from(claves).sort((a, b) => a.localeCompare(b, 'es')).forEach(k => {
            mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es'));
        });
        
        return { claves: Array.from(claves).sort((a, b) => a.localeCompare(b, 'es')), map: mapArrays };
    }

    /**
     * Procesa un CSV de una sola columna para crear una lista simple.
     */
    async function cargarLista(url) {
        const text = await cargarCSV(url);
        const filas = text.trim().split('\n').slice(1).filter(l => l.trim());
        const lista = filas.map(line => line.split(',')[0].trim().replace(/^"|"$/g, ''));
        return Array.from(new Set(lista)).filter(Boolean).sort((a, b) => a.localeCompare(b, 'es'));
    }

    // ======================================================================
    // ---------------------- Persistencia y Bloqueo ------------------------
    // ======================================================================

    function guardarNotas() {
        localStorage.setItem('notasPlanas', JSON.stringify(notas));
        localStorage.setItem('nextOrdenCapturaPlanas', nextOrdenCaptura);
    }

    function cargarNotas() {
        const storedNotas = localStorage.getItem('notasPlanas');
        const storedNextOrdenCaptura = localStorage.getItem('nextOrdenCapturaPlanas');

        if (storedNextOrdenCaptura) {
            nextOrdenCaptura = parseInt(storedNextOrdenCaptura);
        }

        if (storedNotas) {
            try {
                notas = JSON.parse(storedNotas);
                const maxOrden = notas.reduce((max, nota) => Math.max(max, nota.ordenCaptura || 0), 0);
                if (maxOrden >= nextOrdenCaptura) {
                    nextOrdenCaptura = maxOrden + 1;
                }
                renderizarTabla();
            } catch (e) {
                console.error("Error al cargar notas:", e);
                notas = [];
            }
        }
    }

    /**
     * Alterna el estado de bloqueo de un campo y persiste el valor si se bloquea.
     */
    function alternarBloqueo(idCampo) {
        const campo = document.getElementById(idCampo);
        const checkbox = document.getElementById(`check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`);
        
        const isChecked = checkbox.checked;
        
        campo.readOnly = isChecked;
        campo.classList.toggle("bloqueado", isChecked);
        localStorage.setItem(`bloqueado_${idCampo}_Planas`, isChecked);

        if (isChecked) {
            localStorage.setItem(`valorBloqueado_${idCampo}_Planas`, campo.value);
        } else {
            localStorage.removeItem(`valorBloqueado_${idCampo}_Planas`);
        }
        
        // Cierra sugerencias si se est치 interactuando con el campo
        const sugCont = document.getElementById(`sug${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`);
        if (sugCont) sugCont.innerHTML = '';
    }

    /**
     * Alterna el bloqueo del campo que tiene el foco. Usado por el atajo Ctrl+Shift+L.
     */
    function alternarBloqueoFoco(elemento) {
        const id = elemento.id;
        const checkId = `check${id.charAt(0).toUpperCase() + id.slice(1)}`;
        const checkbox = document.getElementById(checkId);
        
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            alternarBloqueo(id);
        }
    }


    // ======================================================================
    // ---------------------- L칩gica de Autocompletado ----------------------
    // ======================================================================

    /**
     * Configura el autocompletado avanzado para un campo.
     */
    function setupAutocomplete(idCampo, lista, callback) {
        const campo = document.getElementById(idCampo);
        const contenedorId = `sug${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
        const contenedor = document.getElementById(contenedorId);
        let indice = -1;

        // Guarda la lista en el data-set
        campo.dataset.lista = JSON.stringify(lista);
        
        // Limpiar autocompletado anterior (si existe)
        if (campo.hasAttribute('data-autocompleted')) {
             campo.removeEventListener('input', campo.oninputHandler);
             campo.removeEventListener('focus', campo.onfocusHandler);
             campo.removeEventListener('blur', campo.onblurHandler);
             campo.removeEventListener('keydown', campo.onkeydownHandler);
        }
        campo.dataset.autocompleted = true; // Marca como inicializado

        const generarSugerencias = () => {
            const valor = campo.value.toLowerCase().trim();
            contenedor.innerHTML = "";
            indice = -1;
            
            // Si el campo est치 bloqueado, no mostrar sugerencias
            if (campo.readOnly) return; 

            if (!valor && document.activeElement !== campo && !campo.dataset.mostrarTodas) return;
            
            const sugerencias = lista.filter(item => !valor || item.toLowerCase().includes(valor));

            if (sugerencias.length === 0) return;

            sugerencias.forEach((s, i) => {
                const div = document.createElement("div");
                div.textContent = s;
                div.className = "sugerencia";
                div.dataset.index = i;
                div.onclick = () => {
                    campo.value = s;
                    contenedor.innerHTML = "";
                    if (callback) callback(s);
                    campo.dispatchEvent(new Event('blur')); 
                };
                contenedor.appendChild(div);
            });
            delete campo.dataset.mostrarTodas;
        };

        // Guardar las funciones para poder eliminarlas si es necesario
        campo.oninputHandler = generarSugerencias;
        campo.onfocusHandler = () => {
            document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");
            generarSugerencias();
        };
        campo.onblurHandler = () => {
            setTimeout(() => {
                if (!contenedor.contains(document.activeElement)) {
                    contenedor.innerHTML = "";
                    if (callback) {
                        const match = lista.find(item => item.toLowerCase() === campo.value.toLowerCase());
                        callback(match || null);
                    }
                }
            }, 150);
        };
        
        campo.onkeydownHandler = e => {
            const items = contenedor.querySelectorAll(".sugerencia");
            if (items.length === 0) return;
            
            if (e.key === "ArrowDown") {
                e.preventDefault();
                indice = (indice + 1) % items.length;
                resaltar(items, indice);
                items[indice].scrollIntoView({ block: 'nearest' });
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                indice = (indice - 1 + items.length) % items.length;
                resaltar(items, indice);
                items[indice].scrollIntoView({ block: 'nearest' });
            } 
            
            else if ((e.key === "Enter" || e.key === "Tab")) {
                let itemToSelect = null;
                
                if (indice >= 0 && items[indice] && items[indice].classList.contains('resaltado')) {
                    itemToSelect = items[indice];
                } else if (items.length === 1) {
                    itemToSelect = items[0];
                }
                
                if (itemToSelect) {
                    e.preventDefault(); // Evita el comportamiento normal de Tab/Enter
                    itemToSelect.click();
                    
                    // Salto al siguiente input
                    const nextInputId = campo.dataset.nextInput;
                    if (nextInputId) {
                        const nextInput = document.getElementById(nextInputId);
                        // Permitir enfocar incluso si est치 bloqueado, para la navegaci칩n
                        if (nextInput) nextInput.focus();
                    }
                }
            }
        };

        campo.addEventListener('input', campo.oninputHandler);
        campo.addEventListener('focus', campo.onfocusHandler);
        campo.addEventListener('blur', campo.onblurHandler);
        campo.addEventListener('keydown', campo.onkeydownHandler);


        function resaltar(items, i) {
            items.forEach(el => el.classList.remove("resaltado"));
            items[i].classList.add("resaltado");
        }
    }
    
    // Funci칩n de dependencia: Dependencia -> Organismo
    function updateOrganismo(dependenciaSeleccionada) {
        const listaOrganismos = dependenciaMap[dependenciaSeleccionada] || [];
        // Re-inicializa el campo Organismo con la nueva lista
        setupAutocomplete("organismo", listaOrganismos);
        document.getElementById('organismo').value = ''; 
        
        const organismoInput = document.getElementById('organismo');
        const checkOrganismo = document.getElementById('checkOrganismo');

        // L칩gica de bloqueo si no hay dependencia v치lida O si el campo est치 bloqueado por el checkbox
        if (!dependenciaSeleccionada || checkOrganismo.checked) {
            organismoInput.readOnly = true;
            organismoInput.classList.add("bloqueado");
        } else {
            organismoInput.readOnly = false;
            organismoInput.classList.remove("bloqueado");
        }
    }

    // Funci칩n simple para mostrar/ocultar el contenedor de sugerencias al hacer clic en el bot칩n
    function mostrarSugerencias(idCampo) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(`sug${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`);
        
        // Simula un focus para que el listener de onfocusHandler se encargue de la l칩gica
        if (contenedor.innerHTML.trim() !== '') {
            contenedor.innerHTML = ''; // Cierra
        } else {
             // Muestra todas si el campo est치 vac칤o
            if (campo.value.trim() === '') {
                 campo.dataset.mostrarTodas = true; 
            }
            campo.focus(); // Abre
        }
    }

    // ======================================================================
    // --------------------------- L칩gica CRUD ------------------------------
    // ======================================================================

    function guardarRegistro() {
        const form = document.getElementById('formCaptura');
        const nuevaNota = {};
        const camposFaltantes = [];

        // 1. Recoger y validar datos
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const input = document.getElementById(id);
            const value = input ? input.value.trim() : '';
            nuevaNota[id] = value;
            
            if (camposObligatorios.includes(id) && value === '') {
                 camposFaltantes.push(encabezadosTabla[id]);
            }
        });

        if (camposFaltantes.length > 0) {
            alert(`游뚿 Por favor, llene los siguientes campos obligatorios: \n\n${camposFaltantes.join(', ')}`);
            return;
        }
        
        // 2. Guardar/Actualizar nota
        if (filaEnEdicion !== null) {
            // Actualizar
            nuevaNota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
            notas[filaEnEdicion] = nuevaNota;
            resetearEstadoEdicion();
        } else {
            // Nueva nota
            nuevaNota.ordenCaptura = nextOrdenCaptura++; 
            notas.push(nuevaNota);
        }
        
        guardarNotas();
        renderizarTabla();
        
        // 3. Limpiar campos NO bloqueados
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const campo = document.getElementById(id);
            // Si el campo NO est치 bloqueado, se limpia su valor y persistencia temporal
            if (localStorage.getItem(`bloqueado_${id}_Planas`) !== 'true') {
                campo.value = '';
                localStorage.removeItem(id);
            }
        });

        // Asegura que los campos dependientes tambi칠n se actualicen
        updateOrganismo(document.getElementById('dependencia').value || null);
        
        document.getElementById('usuario').focus();
    }

    function editarNota(notaId) {
        const indice = notas.findIndex(n => n.ordenCaptura === notaId);
        const nota = notas[indice];

        if (indice === -1 || !nota) return;

        // 1. Resetear edici칩n anterior
        resetearEstadoEdicion(); 
        
        // 2. Cargar datos al formulario
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const campo = document.getElementById(id);
            if (campo) { 
                campo.value = nota[id] || '';
            }
        });
        
        // 3. Asegurar que las listas dependientes se carguen (Dependencia -> Organismo)
        updateOrganismo(nota.dependencia);
        
        // 4. Marcar la fila como editada y estado
        const tr = document.querySelector(`tr[data-id="${notaId}"]`);
        if(tr) tr.classList.add('editando');

        filaEnEdicion = indice;
        
        // Mostrar bot칩n contextual para borrar la nota en edici칩n
        document.getElementById('btnEliminarNota').style.display = 'inline-block';
        document.getElementById('btnGuardar').textContent = '游 Actualizar Nota (Ctrl+Q)';
        document.getElementById('usuario').focus();
    }

    function borrarNota() {
        if (filaEnEdicion !== null) {
            const orden = notas[filaEnEdicion].ordenCaptura;
            const confirmar = confirm(`쮻esea eliminar la nota con D칈GITO VERIFICADOR #${orden}? Esta acci칩n no se puede deshacer.`);
            if (confirmar) {
                notas.splice(filaEnEdicion, 1);
                guardarNotas();
                document.getElementById('formCaptura').reset();
                resetearEstadoEdicion();
                renderizarTabla();
            }
        }
    }

    function resetearEstadoEdicion() {
        const filaEditando = document.querySelector('.editando');
        if (filaEditando) {
            filaEditando.classList.remove('editando');
        }
        filaEnEdicion = null;
        document.getElementById('btnEliminarNota').style.display = 'none';
        document.getElementById('btnGuardar').textContent = '游 Guardar (Ctrl+Q)';
        
        // Asegurar que el campo Organismo se reestablezca correctamente
        updateOrganismo(document.getElementById('dependencia').value || null);
    }

    function borrarTodo() {
        if (confirm("游뚿 ADVERTENCIA: 쮼st치 seguro que desea BORRAR TODAS las notas capturadas? Esta acci칩n es irreversible.")) {
            notas = [];
            nextOrdenCaptura = 1;
            localStorage.removeItem('notasPlanas');
            localStorage.removeItem('nextOrdenCapturaPlanas');
            renderizarTabla();
            limpiarFormulario(); 
        }
    }
    
    /**
     * Limpia el formulario y desactiva todos los bloqueos.
     */
    function limpiarFormulario() {
        document.getElementById('formCaptura').reset();
        resetearEstadoEdicion();
        
        // Desactivar todos los bloqueos
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (checkbox.checked) {
                checkbox.checked = false;
                alternarBloqueo(id);
            }
             // Limpiar persistencia temporal del valor (si no estaba bloqueado)
             localStorage.removeItem(id);
        });
        
        // Asegurar que Organismo se reestablezca
        updateOrganismo(null);
    }
    
    // ======================================================================
    // ----------------------- MANEJO DE LA TABLA ---------------------------
    // ======================================================================

    function renderizarTabla() {
        const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
        tablaBody.innerHTML = '';

        notas.forEach(nota => {
            const tr = document.createElement("tr");
            tr.dataset.id = nota.ordenCaptura;

            // Aplicar resalte amarillo si Tema est치 vac칤o
            if (!nota.tema || nota.tema.trim() === '') {
                tr.classList.add('alerta-vacio');
            }

            const columnasEnOrden = [
                'ordenCaptura', 'usuario', 'fecha', 'medio', 'titular', 'recurso', 
                'dependencia', 'organismo', 'tema', 'estatus'
            ];

            columnasEnOrden.forEach(colKey => {
                const td = document.createElement("td");
                // Usar Date.parse() para ordenar fechas correctamente si es la columna de fecha
                let contenido = nota[colKey] || '';
                
                // Formato de fecha para la tabla
                if (colKey === 'fecha') {
                    try {
                        // Formato YYYY-MM-DD
                        const partes = contenido.split('-'); 
                        if (partes.length === 3) {
                            contenido = `${partes[2]}/${partes[1]}/${partes[0]}`; // DD/MM/YYYY
                        }
                    } catch (e) { /* ignore */ }
                }

                td.textContent = contenido;
                tr.appendChild(td);
            });
            
            // Columna de Acciones
            const tdAcciones = document.createElement("td");
            const btnEditar = document.createElement("button");
            btnEditar.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
            btnEditar.className = "btn-accion-tabla";
            btnEditar.title = "Editar Nota";
            btnEditar.onclick = (e) => {
                 e.stopPropagation(); // Evita que se active cualquier otro click de fila
                 editarNota(nota.ordenCaptura);
            };
            tdAcciones.appendChild(btnEditar);
            tr.appendChild(tdAcciones);

            tablaBody.appendChild(tr);

            // Resalta la fila si est치 en edici칩n
            if (filaEnEdicion !== null && notas[filaEnEdicion].ordenCaptura === nota.ordenCaptura) {
                tr.classList.add('editando');
            }
        });
    }

    // ======================================================================
    // --------------------------- EXPORTAR CSV -----------------------------
    // ======================================================================

    function exportarCSV() {
        if (notas.length === 0) {
            alert("No hay notas para exportar.");
            return;
        }

        const headers = camposDeDatos.map(key => `"${encabezadosTabla[key]}"`).join(',');
        
        const rows = notas.map(nota => 
            camposDeDatos.map(key => {
                let value = nota[key] || '';
                // Escapar comillas en el contenido y envolver en comillas si hay comas o saltos de l칤nea
                value = value.replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n')) {
                    value = `"${value}"`;
                }
                return value;
            }).join(',')
        ).join('\n');
        
        const csvContenido = headers + '\n' + rows;
        
        const usuarioValor = document.getElementById('usuario').value.trim() || 'Desconocido';
        
        // Formato AAMMDD
        const now = new Date();
        const year = String(now.getFullYear()).slice(-2);
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const fecha = `${year}${month}${day}`;

        const nombreArchivo = `${usuarioValor}_${fecha}.csv`;

        const blob = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = nombreArchivo;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // ======================================================================
    // --------------------- Manejo de Atajos de Teclado --------------------
    // ======================================================================

    document.addEventListener('keydown', e => {
        const activeElement = document.activeElement;
        
        // 1. Desactivar Enter para submit/guardar si no es autocompletado
        if (e.key === 'Enter' && activeElement.tagName === 'INPUT' && activeElement.type !== 'submit') {
             const contenedorSugerencias = activeElement.parentNode.querySelector('.sugerencias');
             if (!contenedorSugerencias || contenedorSugerencias.innerHTML === '' || !contenedorSugerencias.querySelector('.sugerencia')) {
                e.preventDefault(); // Solo si no hay sugerencias visibles y activas
             }
             return;
        }
        
        // 2. Atajo Ctrl+Q: Guardar/Actualizar
        if (e.ctrlKey && e.key.toLowerCase() === 'q') {
            e.preventDefault(); 
            document.getElementById('btnGuardar').click(); // Simula el click
            return;
        }
        
        // 3. Atajo Ctrl+Shift+L: Bloquear/Desbloquear el campo actual
        if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l') {
            e.preventDefault(); 
            if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT' || activeElement.tagName === 'TEXTAREA') {
                alternarBloqueoFoco(activeElement);
            }
        }
    });

    // ======================================================================
    // --------------------------- INICIALIZACI칍N ---------------------------
    // ======================================================================

    document.addEventListener("DOMContentLoaded", async () => {
        // --- 1. Carga de Listas (Intentar치 cargar desde GitHub RAW) ---
        try {
            const [depData, listaMedios, listaRecursos, listaTemas, listaEstatus] = await Promise.all([
                cargarMapa(urls.dependencia),
                cargarLista(urls.medio),
                cargarLista(urls.recurso),
                cargarLista(urls.tema),
                cargarLista(urls.estatus)
            ]);
            
            dependenciaMap = depData.map;
            listasAutocompletado = {
                medio: listaMedios,
                recurso: listaRecursos,
                tema: listaTemas,
                estatus: listaEstatus,
                dependencia: depData.claves,
                organismo: [] // Se inicializa vac칤o, se llena con dependencia
            };
            
            document.getElementById("errorCargaCSV").style.display = 'none';

            // 2. Configuraci칩n de Autocompletado
            
            // Dependencia (con callback para actualizar Organismo)
            setupAutocomplete("dependencia", listasAutocompletado.dependencia, dependenciaSeleccionada => {
                updateOrganismo(dependenciaSeleccionada);
            });
            
            // El campo Organismo se inicializa con una lista vac칤a.
            setupAutocomplete("organismo", listasAutocompletado.organismo); 
            
            // Campos simples
            setupAutocomplete("medio", listasAutocompletado.medio);
            setupAutocomplete("recurso", listasAutocompletado.recurso);
            setupAutocomplete("tema", listasAutocompletado.tema);
            setupAutocomplete("estatus", listasAutocompletado.estatus);


        } catch (error) {
            console.warn("La carga de datos CSV fall칩, usando listas vac칤as.", error);
        }

        // 3. Cargar Notas y Bloqueos de LocalStorage
        
        // Cargar estado de bloqueo y valor persistente
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const campo = document.getElementById(id);
            const checkId = `check${id.charAt(0).toUpperCase() + id.slice(1)}`;
            const checkbox = document.getElementById(checkId);

            const isBloqueado = localStorage.getItem(`bloqueado_${id}_Planas`) === 'true';
            const valorBloqueado = localStorage.getItem(`valorBloqueado_${id}_Planas`);
            const valorTemp = localStorage.getItem(id);

            if (isBloqueado) {
                checkbox.checked = true;
                campo.readOnly = true;
                campo.classList.add("bloqueado");
                if (valorBloqueado) campo.value = valorBloqueado;
                
                if (id === 'dependencia') {
                    updateOrganismo(valorBloqueado || null);
                }
            } else {
                 // Si no est치 bloqueado, se carga el valor de persistencia temporal
                 if (valorTemp) {
                     campo.value = valorTemp;
                     if (id === 'dependencia') {
                        updateOrganismo(valorTemp);
                    }
                 }
                 
                 // Listener para guardar el valor temporal si no est치 bloqueado
                 campo.addEventListener("input", () => {
                    localStorage.setItem(id, campo.value);
                });
            }
        });

        cargarNotas();
        
        // 4. Configurar Evento del Bot칩n Guardar
        document.getElementById('btnGuardar').addEventListener('click', guardarRegistro);
        
        // 5. Establecer la fecha actual en el campo fecha si est치 vac칤o
        const fechaInput = document.getElementById('fecha');
        if (!fechaInput.value) {
            const today = new Date().toISOString().split('T')[0];
            fechaInput.value = today;
        }
    });
</script>
</body>
</html>